name: CI

on:
  push:
    branches:
      - "**"
    tags:
      - "v*"
      - "*.*.*"
      - "*.*.*.*"
  pull_request:

jobs:
  syntax:
    name: tox (syntax)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade tox

      - name: Run tox
        run: |
          tox run -e syntax

  test:
    name: tox (-f ${{ matrix.tox_factor }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: "3.10"
            tox_factor: py310
          - python-version: "3.11"
            tox_factor: py311
          - python-version: "3.12"
            tox_factor: py312
          - python-version: "3.13"
            tox_factor: py313
          - python-version: "3.14"
            tox_factor: py3.14

    services:
      postgres:
        image: postgis/postgis:15-3.4
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: postpone_index
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U test -d postpone_index"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true
          cache: pip

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade tox

      - name: Install GDAL/GEOS (for PostGIS tests)
        run: |
          sudo apt-get update
          sudo apt-get install -y gdal-bin libgdal-dev libgeos-dev

      - name: Run tox
        run: |
          tox run -f ${{ matrix.tox_factor }}

  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [syntax, test]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Determine if this is a release tag
        id: release
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          python - <<'PY'
          import os, re
          tag = os.environ.get("TAG_NAME", "")
          is_release = bool(re.match(r"^(?:v)?\d+\.\d+\.\d+(?:\.\d+)?$", tag))
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write(f"is_release={str(is_release).lower()}\n")
          print(f"tag={tag} is_release={is_release}")
          PY

      - name: Build distributions
        if: steps.release.outputs.is_release == 'true'
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade build
          python -m build

      - name: Publish distributions to PyPI
        if: steps.release.outputs.is_release == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
